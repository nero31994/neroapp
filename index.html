<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Minimal IPTV Player</title>

  <!-- Shaka Player -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.12.6/shaka-player.compiled.js" defer></script>

  <!-- Link to the external CSS -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- Loading Spinner -->
  <div id="loading-spinner" class="loading-spinner" style="display: none;"></div>

  <!-- Frame -->
  <div class="frame">
    <div class="search-container">
      <input type="text" id="search" placeholder="Search channels..." aria-label="Search channels">
    </div>
    <div id="channel-frame" class="channel-frame">
      <!-- Channels will be loaded dynamically from channels.js -->
    </div>
  </div>

  <!-- Main Content -->
  <main class="content">
    <video id="video" controls autoplay>
      Your browser does not support the video tag.
    </video>
    <div class="controls">
      <button id="play-pause-btn">Pause</button>
      <button id="fullscreen-btn">Full Screen</button>
      <div>
        <label for="volume">Volume:</label>
        <input type="range" id="volume" class="volume-slider" min="0" max="1" step="0.1" value="1">
      </div>
    </div>
  </main>

  <script src="channels.js"></script> <!-- Ensure channels.js is correctly linked -->
  <script src="remote-control.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const videoElement = document.getElementById("video");
      const channelFrame = document.getElementById("channel-frame");
      const searchInput = document.getElementById("search");
      const playPauseBtn = document.getElementById("play-pause-btn");
      const fullscreenBtn = document.getElementById("fullscreen-btn");
      const volumeSlider = document.getElementById("volume");
      const loadingSpinner = document.getElementById("loading-spinner");
      let currentChannelIndex = 0;

      // Ensure channels are properly defined
      if (typeof channels === 'undefined' || typeof channels !== 'object') {
        console.error("Channels not loaded. Ensure channels.js is included and properly configured.");
        return;
      }

      const player = new shaka.Player(videoElement);

      async function loadChannel(channel) {
        try {
          loadingSpinner.style.display = 'block'; // Show loading spinner

          // Handle DRM configuration
          if (channel.drm && channel.drm.kid && channel.drm.key) {
            player.configure({
              drm: {
                clearKeys: { [channel.drm.kid]: channel.drm.key }
              }
            });
          }

          await player.load(channel.url); // Load the stream URL
          loadingSpinner.style.display = 'none'; // Hide loading spinner
          console.log(`Playing: ${channel.name}`);
          enterFullScreen(videoElement);
        } catch (error) {
          console.error("Error loading channel:", error);
          alert(`Failed to load channel: ${channel.name}`);
          loadingSpinner.style.display = 'none'; // Hide loading spinner
        }
      }

      function enterFullScreen(element) {
        if (element.requestFullscreen) {
          element.requestFullscreen();
        } else if (element.mozRequestFullScreen) {
          element.mozRequestFullScreen();
        } else if (element.webkitRequestFullscreen) {
          element.webkitRequestFullscreen();
        } else if (element.msRequestFullscreen) {
          element.msRequestFullscreen();
        }
      }

      function displayChannels(filteredChannels) {
        channelFrame.innerHTML = ""; // Clear existing channels
        filteredChannels.forEach((channel, index) => {
          const button = document.createElement("button");
          button.textContent = channel.name;
          button.dataset.index = index;
          button.onclick = () => {
            currentChannelIndex = index;
            loadChannel(channel);
            updateActiveChannel();
          };
          channelFrame.appendChild(button); // Append the button to the channel list
        });
        updateActiveChannel();
      }

      function updateActiveChannel() {
        const buttons = document.querySelectorAll('.channel-frame button');
        buttons.forEach((btn, idx) => {
          btn.classList.toggle('active', idx === currentChannelIndex);
        });
      }

      // Convert the channels object to an array and initial loading of channels
      displayChannels(Object.values(channels));

      // Search functionality
      searchInput.addEventListener("input", () => {
        const searchTerm = searchInput.value.toLowerCase();
        const filteredChannels = Object.values(channels).filter(channel =>
          channel.name.toLowerCase().includes(searchTerm)
        );
        displayChannels(filteredChannels);
      });

      // Play/Pause button
      playPauseBtn.addEventListener("click", () => {
        if (videoElement.paused) {
          videoElement.play();
          playPauseBtn.textContent = "Pause";
        } else {
          videoElement.pause();
          playPauseBtn.textContent = "Play";
        }
      });

      // Fullscreen button
      fullscreenBtn.addEventListener("click", () => {
        enterFullScreen(videoElement);
      });

      // Volume control
      volumeSlider.addEventListener("input", () => {
        videoElement.volume = volumeSlider.value;
      });
    });
  </script>
</body>
</html>
